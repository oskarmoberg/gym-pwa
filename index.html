<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Gym Logger — Pass</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#0b1220; --card:#0d1322; --muted:#94a3b8; --text:#e5e7eb; --ok:#22c55e; --warn:#ef4444; --border:#1f2937; }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Inter,Roboto}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select, input, button {
  width: 100%;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid #243244;
  background: #000;
  color: var(--text);
  font-weight: 700;
  font-size: 16px; /* ← stoppar iPhone från att zooma in */
}

    input::placeholder{color:#64748b}
    .btn{background:linear-gradient(180deg,#23c55e,#16a34a);border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #334155;font-weight:600}
    .title{font-size:22px;font-weight:800;margin:0 0 10px}
    .muted{color:var(--muted);font-size:12px}
    .sp{height:10px}
    table{width:100%;border-collapse:collapse;background:#0b1220;border-radius:12px;overflow:hidden}
    th,td{padding:14px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#0f172a;font-weight:800}
    tr:last-child td{border-bottom:none}
    .ok{color:var(--ok);font-weight:800}
    .warn{color:var(--warn);font-weight:800}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #253043;border-radius:999px;color:#cbd5e1;background:#0b1220;font-size:12px}
    .footer{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:820px){.grid{grid-template-columns:1.2fr .8fr}}
    /* Modal */
    #exModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:12px}
    #exModal .box{background:#0d1322;border:1px solid var(--border);border-radius:16px;padding:16px;width:min(720px,95vw)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <!-- VÄNSTER: AKTIVT PASS -->
    <section class="card">
      <h1 class="title">Aktivt pass</h1>

      <!-- Övning + datum + hantera -->
      <div class="row">
        <div class="col">
          <label>Övning</label>
          <div class="row" style="gap:8px">
            <select id="exercise" style="flex:1 1 auto"></select>
            <button id="manageExercises" class="btn ghost" style="flex:0 0 auto;min-width:160px">Hantera övningar</button>
          </div>
        </div>
        <div class="col">
          <label>Datum</label>
          <input type="date" id="date">
        </div>
      </div>

      <div class="sp"></div>

      <!-- Inputs + Addera -->
      <div class="row">
        <div class="col">
          <label>Vikt (kg)</label>
          <input id="weight" inputmode="decimal" placeholder="t.ex. 140">
        </div>
        <div class="col">
          <label>Reps</label>
          <input id="reps" inputmode="numeric" placeholder="t.ex. 5">
        </div>
        <div class="col" style="align-self:end">
          <button id="add" class="btn">Addera</button>
        </div>
      </div>

      <div class="sp"></div>

      <!-- Tabell -->
      <table>
        <thead>
          <tr>
            <th>Vikt</th>
            <th>Reps</th>
            <th>Färdigt?</th>
          </tr>
        </thead>
        <tbody id="currentTbody"></tbody>
        <tbody>
          <tr id="suggestRow">
            <td class="warn" id="sugWeight">–</td>
            <td class="warn" id="sugReps">–</td>
            <td class="warn" id="sugNote">Förslag</td>
          </tr>
        </tbody>
      </table>

      <div class="sp"></div>
      <div class="row">
        <div class="col pill">Senaste max: <span id="lastMax">—</span></div>
        <div class="col pill">Senaste datum: <span id="lastDate">—</span></div>
      </div>

      <div class="sp"></div>
      <div class="pill" id="autosaveStatus">Autosparat</div>
    </section>

    <!-- HÖGER: HISTORIK -->
    <section class="card">
      <h2 class="title">Historik</h2>
      <div class="muted">Senaste 10 för vald övning:</div>
      <div id="history" style="margin-top:8px;display:grid;gap:8px"></div>
      <div class="sp"></div>
      <div class="footer">
        <button class="btn ghost" id="exportJSON">Export JSON</button>
        <button class="btn ghost" id="exportCSV">Export CSV</button>
      </div>
    </section>
  </div>
</div>

<!-- MODAL: Hantera övningar -->
<div id="exModal">
  <div class="box">
    <h3 style="margin:0 0 8px">Övning</h3>
    <div class="row">
      <div class="col">
        <label>Namn</label>
        <input id="exName" placeholder="t.ex. Bicepscurl">
      </div>
      <div class="col">
        <label>Kategori</label>
        <select id="exCategory">
          <option value="base">Baslyft</option>
          <option value="hybrid">Press/drag</option>
          <option value="iso">Isolation</option>
        </select>
      </div>
    </div>
    <div class="sp"></div>
    <div class="row">
      <div class="col"><label>Arbetset</label><input id="exWorkSets" inputmode="numeric" value="3"></div>
      <div class="col"><label>Reps (min–max)</label><input id="exRepsRange" placeholder="6-8" value="6-8"></div>
      <div class="col"><label>Warmups (%)</label><input id="exWarmups" placeholder="50,70,85" value="50,70,85"></div>
    </div>
    <div class="sp"></div>
    <div class="row">
      <div class="col"><label>Ökningssteg (kg)</label><input id="exInc" inputmode="decimal" value="2.5"></div>
      <div class="col"><label>Stor ökning (kg)</label><input id="exBigInc" inputmode="decimal" value="5"></div>
      <div class="col"><label>Frekvens (dagar)</label><input id="exFreqDays" inputmode="numeric" value="4"></div>
    </div>
    <div class="sp"></div>
    <div class="row">
      <div class="col"><button id="exSave" class="btn">Spara övning</button></div>
      <div class="col"><button id="exClose" class="btn ghost">Stäng</button></div>
    </div>
    <div class="sp"></div>
    <div class="muted">Tips: Isolation → 3–4 set, 10–15 reps, warmups kan vara tomt eller 40.</div>
  </div>
</div>

<script>
/* ==================== KONFIG ==================== */
const SITE_URL = 'https://oskamoberg.github.io/gym-pwa/';

/* ==================== DB ==================== */
const DB_NAME='gymlogger_db'; const STORE='workouts';
let db;
function idbOpen(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB_NAME, 2); // v2: lägger till exercises-store
    r.onupgradeneeded = e=>{
      const d = e.target.result;
      if(!d.objectStoreNames.contains(STORE)){
        d.createObjectStore(STORE, { keyPath:'id', autoIncrement:true });
      }
      if(!d.objectStoreNames.contains('exercises')){
        d.createObjectStore('exercises', { keyPath:'name' }); // unik på namn
      }
    };
    r.onsuccess=()=>{ db=r.result; res(); };
    r.onerror=()=>rej(r.error);
  });
}
function idbAdd(workout){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
    tx.objectStore(STORE).add(workout);
  });
}
function idbAll(){
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readonly');
    const st = tx.objectStore(STORE);
    const g = st.getAll();
    g.onsuccess=()=>res(g.result);
    g.onerror=()=>rej(g.error);
  });
}
async function idbUpsertByDateExercise(dateISO, exercise, sets){
  const all=await idbAll();
  const found=all.find(w=>w.dateISO===dateISO && w.exercise===exercise);
  const est1RM = sets.length ? Math.max(...sets.map(s=>epley(s.weightKg,s.reps))) : 0;
  if(found){
    await new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).delete(found.id);
      tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});
    await idbAdd({ id:found.id, dateISO, exercise, sets, est1RM, notes: found.notes||'' });
  } else {
    await idbAdd({ dateISO, exercise, sets, est1RM, notes:'' });
  }
  flashAutosaved();
}

/* = exercises store helpers */
function exAll(){return new Promise((res,rej)=>{const tx=db.transaction('exercises','readonly');const st=tx.objectStore('exercises');const g=st.getAll();g.onsuccess=()=>res(g.result);g.onerror=()=>rej(g.error);});}
function exPut(ex){return new Promise((res,rej)=>{const tx=db.transaction('exercises','readwrite');tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);tx.objectStore('exercises').put(ex);});}

/* ==================== UTIL ==================== */
const $=q=>document.querySelector(q);
const fmt=n=>Number(n).toLocaleString('sv-SE',{maximumFractionDigits:1});
const todayISO=()=>new Date().toISOString().slice(0,10);
const epley=(w,r)=> r>1 ? w*(1+r/30) : w;
function flashAutosaved(){ const el=$('#autosaveStatus'); el.textContent='Autosparat ✅'; setTimeout(()=>el.textContent='Autosparat',1000); }

/* ==================== STATE ==================== */
let currentSets=[]; // {weightKg,reps,done}

/* ==================== SEED DEFAULT EXERCISES ==================== */
async function seedExercisesIfEmpty(){
  const list = await exAll();
  if(list.length) return;
  const defaults = [
    { name:'Marklyft', category:'base',   workSets:3, repsMin:3, repsMax:5,  warmups:[50,70,85], inc:2.5, bigInc:5, freqDays:5 },
    { name:'Bänkpress',category:'hybrid', workSets:3, repsMin:6, repsMax:8,  warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:3 },
    { name:'Knäböj',   category:'base',   workSets:3, repsMin:3, repsMax:5,  warmups:[50,70,85], inc:2.5, bigInc:5, freqDays:4 },
    { name:'Militärpress',category:'hybrid',workSets:3,repsMin:6,repsMax:8,  warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:4 },
    { name:'Chins',    category:'hybrid', workSets:3, repsMin:6, repsMax:10, warmups:[40,60],    inc:2.5, bigInc:5, freqDays:3 },
    { name:'Bicepscurl',category:'iso',   workSets:3, repsMin:10,repsMax:15, warmups:[40],       inc:2.5, bigInc:5, freqDays:2 }
  ];
  for(const ex of defaults) await exPut(ex);
}

/* ==================== EXERCISE PARAM FETCH ==================== */
async function getParamsFor(name){
  const all = await exAll();
  const ex = all.find(x=>x.name===name);
  if(ex) return ex;
  // fallback
  return { name, category:'hybrid', workSets:3, repsMin:6, repsMax:8, warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:3 };
}
async function refreshExerciseDropdown(sel){
  const all = await exAll();
  all.sort((a,b)=> a.name.localeCompare(b.name,'sv'));
  sel.innerHTML='';
  for(const ex of all){
    const o=document.createElement('option'); o.value=ex.name; o.textContent=ex.name; sel.appendChild(o);
  }
}

/* ==================== HISTORY/PLANNING ==================== */
function renderHistory(all,ex){
  const list=$('#history'); list.innerHTML='';
  const filt=all.filter(w=>w.exercise===ex).sort((a,b)=>b.dateISO.localeCompare(a.dateISO)).slice(0,10);
  filt.forEach(w=>{
    const div=document.createElement('div'); div.className='pill';
    div.textContent = `${w.dateISO} • ${w.sets.map(s=>`${fmt(s.weightKg)}×${s.reps}`).join(' · ')} • 1RM ${fmt(w.est1RM||0)}`;
    list.appendChild(div);
  });
  const last=filt[0];
  if(last){
    const topW=Math.max(...last.sets.map(s=>s.weightKg));
    const top=last.sets.find(s=>s.weightKg===topW) || last.sets[0];
    $('#lastMax').textContent = `${fmt(top.weightKg)}kg × ${top.reps}`;
    $('#lastDate').textContent = last.dateISO;
  } else {
    $('#lastMax').textContent='—'; $('#lastDate').textContent='—';
  }
}

function lastWorkingSummary(all, exercise, workSets){
  const sessions=all.filter(w=>w.exercise===exercise).sort((a,b)=>b.dateISO.localeCompare(a.dateISO));
  if(!sessions.length) return null;
  const sets=[...sessions[0].sets].sort((a,b)=>b.weightKg-a.weightKg).slice(0, workSets||3);
  if(!sets.length) return null;
  return { dateISO:sessions[0].dateISO, workSets: sets };
}

async function nextTargetWeightByParams(allWorkouts, params, exName){
  const last=lastWorkingSummary(allWorkouts, exName, params.workSets||3);
  if(!last) return null;
  const w = last.workSets[0].weightKg;
  const reps = last.workSets.map(s=>s.reps);
  const allHigh = reps.length>= (params.workSets||3) && reps.every(r=> r>= (params.repsMax||8));
  const anyLow  = reps.some(r=> r <= (params.repsMin||6)-1 );
  if(allHigh) return w + (params.bigInc||5);
  if(anyLow)  return Math.max(0, w - (params.inc||2.5));
  return w;
}

function plannedSetsForSessionByParams(targetWeight, params){
  const warm = (params.warmups||[]).map(pct=>{
    const w = Math.round(targetWeight*(pct/100)/2.5)*2.5;
    const reps = pct>=85 ? 1 : (pct>=70 ? 3 : 5);
    return { weightKg:w, reps, type:'warmup' };
  });
  const work = Array.from({length: params.workSets||3}, (_,i)=>({
    weightKg: targetWeight,
    reps: i===(params.workSets||3)-1
      ? (params.category==='iso' ? `${params.repsMin}-${params.repsMax}` : 'AMRAP')
      : `${params.repsMin}-${params.repsMax}`,
    type:'work',
    idx:i+1
  }));
  return [...warm, ...work];
}

/* ==================== UI RENDER ==================== */
function renderCurrent(){
  const tb=$('#currentTbody'); tb.innerHTML='';
  currentSets.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${fmt(s.weightKg)}kg</td><td>${s.reps}</td>
      <td><span class="ok">X</span>
      <button class="btn ghost" style="margin-left:8px" data-i="${i}">Ta bort</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick=async()=>{
      const i=+b.dataset.i; currentSets.splice(i,1); renderCurrent();
      await idbUpsertByDateExercise($('#date').value||todayISO(), $('#exercise').value, currentSets);
      computeSuggestion();
    };
  });
}

/* ==================== SUGGESTION ==================== */
async function computeSuggestion(){
  const exName = $('#exercise').value;
  const allW = await idbAll();
  const params = await getParamsFor(exName);

  const currentTop = currentSets.length ? currentSets.reduce((a,b)=> a.weightKg>b.weightKg?a:b).weightKg : null;
  const targetFromHist = await nextTargetWeightByParams(allW, params, exName);
  const target = (targetFromHist ?? currentTop ?? 60);

  const plan = plannedSetsForSessionByParams(target, params);
  const done = currentSets.length;

  if(done >= plan.length){
    $('#sugWeight').textContent='—';
    $('#sugReps').textContent='—';
    $('#sugNote').textContent='Klart för idag ✅';
    return;
  }
  const next = plan[done];
  $('#sugWeight').textContent = `${fmt(next.weightKg)}kg`;
  $('#sugReps').textContent   = `${next.reps}`;
  $('#sugNote').textContent   = (next.type==='work' && next.idx===(params.workSets||3)) ? 'Sista – maxa reps' : 'Förslag';
}

/* ==================== INIT & EVENTS ==================== */
async function loadTodayFor(exName){
  const all=await idbAll();
  const dateISO=$('#date').value||todayISO();
  const exist=all.find(w=>w.dateISO===dateISO && w.exercise===exName);
  currentSets = exist ? exist.sets : [];
  renderCurrent(); renderHistory(all, exName); computeSuggestion();
}

(async function init(){
  await idbOpen();
  await seedExercisesIfEmpty();
  $('#date').value = todayISO();
  await refreshExerciseDropdown($('#exercise'));
  if(!$('#exercise').value) $('#exercise').value='Marklyft';
  await loadTodayFor($('#exercise').value);
})();

$('#exercise').addEventListener('change', async ()=>{
  await loadTodayFor($('#exercise').value);
});

$('#add').addEventListener('click', async ()=>{
  const w = +($('#weight').value||0); const r = +($('#reps').value||0);
  if(w<=0 || r<=0) return alert('Ange både vikt och reps.');
  currentSets.push({weightKg:w, reps:r, done:true});
  $('#weight').value=''; $('#reps').value='';
  renderCurrent();
  await idbUpsertByDateExercise($('#date').value||todayISO(), $('#exercise').value, currentSets);
  computeSuggestion();
});

$('#exportJSON').addEventListener('click', async ()=>{
  const all = await idbAll();
  const txt = JSON.stringify(all,null,2);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([txt],{type:'application/json'}));
  a.download=`workouts_${todayISO()}.json`; a.click(); URL.revokeObjectURL(a.href);
});
$('#exportCSV').addEventListener('click', async ()=>{
  const all = await idbAll();
  const rows=[['dateISO','exercise','setIndex','weightKg','reps','est1RM']];
  all.forEach(w=> w.sets.forEach((s,i)=> rows.push([w.dateISO,w.exercise,i+1,s.weightKg,s.reps,(w.est1RM||0).toFixed(1)])));
  const csv = rows.map(r=>r.map(x=>`"${x}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`workouts_${todayISO()}.csv`; a.click(); URL.revokeObjectURL(a.href);
});

/* ====== Hantera övningar (modal) ====== */
$('#manageExercises').onclick = async ()=>{
  const exSel = $('#exercise').value || '';
  const all = await exAll();
  const curr = all.find(x=>x.name===exSel);
  $('#exName').value = curr?.name || '';
  $('#exCategory').value = curr?.category || 'hybrid';
  $('#exWorkSets').value = curr?.workSets ?? 3;
  $('#exRepsRange').value = curr ? `${curr.repsMin}-${curr.repsMax}` : '6-8';
  $('#exWarmups').value = curr?.warmups?.join(',') || '40,60,80';
  $('#exInc').value = curr?.inc ?? 2.5;
  $('#exBigInc').value = curr?.bigInc ?? 5;
  $('#exFreqDays').value = curr?.freqDays ?? 3;
  $('#exModal').style.display='flex';
};
$('#exClose').onclick = ()=> $('#exModal').style.display='none';
$('#exSave').onclick = async ()=>{
  const name = $('#exName').value.trim();
  if(!name) return alert('Ange namn.');
  const [minS,maxS] = ($('#exRepsRange').value||'6-8').split('-').map(x=>+x);
  const warmups = ($('#exWarmups').value||'').split(',').map(x=>+x).filter(x=>x>0);
  const ex = {
    name,
    category: $('#exCategory').value,
    workSets: +$('#exWorkSets').value || 3,
    repsMin: +minS || 6,
    repsMax: +maxS || 8,
    warmups: warmups,
    inc: +$('#exInc').value || 2.5,
    bigInc: +$('#exBigInc').value || 5,
    freqDays: +$('#exFreqDays').value || 3
  };
  await exPut(ex);
  await refreshExerciseDropdown($('#exercise'));
  $('#exercise').value = name;
  $('#exModal').style.display='none';
  await loadTodayFor(name);
};

/* ==================== SERVICE WORKER ==================== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker-v3.js'));
}
</script>
</body>
</html>
