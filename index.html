<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Gym Logger — Pass</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="app.css" />
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#0b1220; --card:#0d1322; --muted:#94a3b8; --text:#e5e7eb; --ok:#22c55e; --warn:#ef4444; --border:#1f2937; }
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Inter,Roboto}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .card{background:#0d1322;border:1px solid var(--border);border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{flex:1 1 220px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

    /* Inputs – anti-zoom och tydligt */
    select,input,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#000;color:var(--text);font-weight:700;font-size:16px}
    input::placeholder{color:#64748b}
    .btn{background:linear-gradient(180deg,#23c55e,#16a34a);border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #334155;font-weight:600}
    .title{font-size:20px;font-weight:800;margin:0 0 8px}
    .muted{color:var(--muted);font-size:12px}
    .sp{height:8px}

    /* Kompakt TABELL */
    table{width:100%;border-collapse:collapse;background:#0b1220;border-radius:10px;overflow:hidden;font-size:14px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#0f172a;font-weight:800}
    tr:last-child td{border-bottom:none}
    .ok{color:var(--ok);font-weight:800}
    .note-warn{color:var(--warn);font-weight:800}
    .delbtn{width:auto;min-width:auto;padding:6px 10px;border-radius:8px;border:1px solid #334155;background:transparent;color:#e5e7eb;font-size:14px;line-height:1}
    .icon{font-size:16px}

    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #253043;border-radius:999px;color:#cbd5e1;background:#0b1220;font-size:12px;white-space:nowrap}

    /* Layout */
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:820px){.grid{grid-template-columns:1.1fr .9fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <!-- VÄNSTER: PASS -->
    <section class="card">
      <h1 class="title">Aktivt pass</h1>

      <!-- Övning & datum -->
      <div class="row">
        <div class="col">
          <label>Övning</label>
          <div class="row" style="gap:8px">
            <select id="exercise" style="flex:1 1 auto"></select>
            <a class="btn ghost" href="exercises.html" style="flex:0 0 auto;min-width:124px;text-align:center">Övningar →</a>
          </div>
        </div>
        <div class="col">
          <label>Datum</label>
          <input type="date" id="date">
        </div>
      </div>

      <div class="sp"></div>

      <!-- TABELL (förslag först) -->
      <table>
        <thead>
          <tr>
            <th>Vikt</th>
            <th>Reps</th>
            <th style="width:80px">Klar</th>
            <th style="width:60px"></th>
          </tr>
        </thead>
        <tbody>
          <tr id="suggestRow">
            <td class="note-warn" id="sugWeight">–</td>
            <td class="note-warn" id="sugReps">–</td>
            <td colspan="2" class="note-warn" id="sugNote">Förslag</td>
          </tr>
        </tbody>
        <tbody id="currentTbody"></tbody>
      </table>

      <div class="sp"></div>

      <!-- Inputs + Addera -->
      <div class="row">
        <div class="col">
          <label>Vikt (kg)</label>
          <input id="weight" inputmode="decimal" pattern="[0-9.,]*" autocomplete="off" autocapitalize="off" placeholder="t.ex. 140">
        </div>
        <div class="col">
          <label>Reps</label>
          <input id="reps" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocapitalize="off" placeholder="t.ex. 5">
        </div>
        <div class="col" style="align-self:end">
          <button id="add" class="btn">Addera</button>
        </div>
      </div>

      <div class="sp"></div>
      <div class="row">
        <div class="col pill">Senaste max: <span id="lastMax">—</span></div>
        <div class="col pill">Senaste datum: <span id="lastDate">—</span></div>
      </div>

      <div class="sp"></div>
      <div class="pill" id="autosaveStatus">Autosparat</div>
    </section>

    <!-- HÖGER: HISTORIK -->
    <section class="card">
      <h2 class="title">Historik</h2>
      <div class="muted">Senaste 10 för vald övning:</div>
      <div id="history" style="margin-top:8px;display:grid;gap:8px"></div>
      <div class="sp"></div>
      <a class="btn ghost" href="export.html">Export →</a>
    </section>
  </div>
</div>

<!-- Bottenmeny -->
<nav class="tabbar">
  <a href="index.html" data-tab="pass">Pass</a>
  <a href="exercises.html" data-tab="exercises">Övningar</a>
  <a href="export.html" data-tab="export">Export</a>
  <a href="dashboard.html" data-tab="dashboard">Mer</a>
</nav>
<script src="nav.js"></script>

<script>
/* ========== IndexedDB setup ========== */
const DB_NAME='gymlogger_db'; const STORE='workouts';
let db;
function idbOpen(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB_NAME, 2);
    r.onupgradeneeded = e=>{
      const d = e.target.result;
      d.objectStoreNames.contains('workouts')||d.createObjectStore('workouts',{keyPath:'id',autoIncrement:true});
      d.objectStoreNames.contains('exercises')||d.createObjectStore('exercises',{keyPath:'name'});
    };
    r.onsuccess=()=>{db=r.result;res()}; r.onerror=()=>rej(r.error);
  });
}
function idbAdd(workout){return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);tx.objectStore(STORE).add(workout);});}
function idbAll(){return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const st=tx.objectStore(STORE);const g=st.getAll();g.onsuccess=()=>res(g.result);g.onerror=()=>rej(g.error);});}
async function idbUpsertByDateExercise(dateISO, exercise, sets){
  const all=await idbAll();
  const found=all.find(w=>w.dateISO===dateISO && w.exercise===exercise);
  const est1RM = sets.length ? Math.max(...sets.map(s=>epley(s.weightKg,s.reps))) : 0;
  if(found){
    await new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).delete(found.id);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});
    await idbAdd({ id:found.id, dateISO, exercise, sets, est1RM, notes: found.notes||'' });
  } else {
    await idbAdd({ dateISO, exercise, sets, est1RM, notes:'' });
  }
  flashAutosaved();
}

/* ========== Exercise helpers ========== */
function exAll(){return new Promise((res,rej)=>{const tx=db.transaction('exercises','readonly');const st=tx.objectStore('exercises');const g=st.getAll();g.onsuccess=()=>res(g.result);g.onerror=()=>rej(g.error);});}
function exPut(ex){return new Promise((res,rej)=>{const tx=db.transaction('exercises','readwrite');tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);tx.objectStore('exercises').put(ex);});}

/* ========== Utils ========== */
const $=q=>document.querySelector(q);
const fmt=n=>Number(n).toLocaleString('sv-SE',{maximumFractionDigits:1});
const todayISO=()=>new Date().toISOString().slice(0,10);
const epley=(w,r)=> r>1 ? w*(1+r/30) : w;
function flashAutosaved(){ const el=$('#autosaveStatus'); el.textContent='Autosparat ✅'; setTimeout(()=>el.textContent='Autosparat',900); }
function parseNumber(value){
  if (value == null) return 0;
  let v = String(value).trim().replace(/\s+/g,'');
  if (v.includes('.') && v.includes(',')) v = v.replace(/,/g,''); else v = v.replace(',', '.');
  const n = Number(v); return Number.isFinite(n) ? n : 0;
}

/* ========== State ========== */
let currentSets=[]; // {weightKg,reps,done}

/* ========== Defaults (seed) ========== */
async function seedExercisesIfEmpty(){
  const list = await exAll(); if(list.length) return;
  const defaults = [
    { name:'Marklyft', category:'base',   workSets:3, repsMin:3, repsMax:5,  warmups:[50,70,85], inc:2.5, bigInc:5, freqDays:5 },
    { name:'Bänkpress',category:'hybrid', workSets:3, repsMin:6, repsMax:8,  warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:3 },
    { name:'Knäböj',   category:'base',   workSets:3, repsMin:3, repsMax:5,  warmups:[50,70,85], inc:2.5, bigInc:5, freqDays:4 },
    { name:'Militärpress',category:'hybrid',workSets:3,repsMin:6,repsMax:8,  warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:4 },
    { name:'Chins',    category:'hybrid', workSets:3, repsMin:6, repsMax:10, warmups:[40,60],    inc:2.5, bigInc:5, freqDays:3 },
    { name:'Bicepscurl',category:'iso',   workSets:3, repsMin:10,repsMax:15, warmups:[40],       inc:2.5, bigInc:5, freqDays:2 }
  ];
  for(const ex of defaults) await exPut(ex);
}

/* ========== Suggestion logic (plan under huven) ========== */
async function getParamsFor(name){
  const all = await exAll(); const ex = all.find(x=>x.name===name);
  return ex || { name, category:'hybrid', workSets:3, repsMin:6, repsMax:8, warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:3 };
}
function lastWorkingSummary(all, exercise, workSets){
  const sessions=all.filter(w=>w.exercise===exercise).sort((a,b)=>b.dateISO.localeCompare(a.dateISO));
  if(!sessions.length) return null;
  const sets=[...sessions[0].sets].sort((a,b)=>b.weightKg-a.weightKg).slice(0, workSets||3);
  if(!sets.length) return null;
  return { dateISO:sessions[0].dateISO, workSets: sets };
}
async function nextTargetWeight(allWorkouts, params, exName){
  const last=lastWorkingSummary(allWorkouts, exName, params.workSets||3);
  if(!last) return null;
  const w = last.workSets[0].weightKg;
  const reps = last.workSets.map(s=>s.reps);
  const allHigh = reps.length>= (params.workSets||3) && reps.every(r=> r>= (params.repsMax||8));
  const anyLow  = reps.some(r=> r <= (params.repsMin||6)-1 );
  if(allHigh) return w + (params.bigInc||5);
  if(anyLow)  return Math.max(0, w - (params.inc||2.5));
  return w;
}
function planFor(targetWeight, params){
  const warm = (params.warmups||[]).map(pct=>{
    const w = Math.round(targetWeight*(pct/100)/2.5)*2.5;
    const reps = pct>=85 ? 1 : (pct>=70 ? 3 : 5);
    return { weightKg:w, reps, type:'warmup' };
  });
  const work = Array.from({length: params.workSets||3}, (_,i)=>({
    weightKg: targetWeight,
    reps: i===(params.workSets||3)-1 ? (params.category==='iso' ? `${params.repsMin}-${params.repsMax}` : 'AMRAP')
                                     : `${params.repsMin}-${params.repsMax}`,
    type:'work', idx:i+1
  }));
  return [...warm, ...work];
}

/* ========== Rendering ========== */
function renderCurrent(){
  const tb=$('#currentTbody'); tb.innerHTML='';
  currentSets.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${fmt(s.weightKg)}kg</td><td>${s.reps}</td>
      <td><span class="ok">✓</span></td>
      <td><button class="delbtn" title="Ta bort" data-i="${i}"><span class="icon">🗑︎</span></button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick=async()=>{
      const i=+b.dataset.i; currentSets.splice(i,1); renderCurrent();
      await idbUpsertByDateExercise($('#date').value||todayISO(), $('#exercise').value, currentSets);
      computeSuggestion();
    };
  });
}

function renderHistory(all,ex){
  const list=$('#history'); list.innerHTML='';
  const filt=all.filter(w=>w.exercise===ex).sort((a,b)=>b.dateISO.localeCompare(a.dateISO)).slice(0,10);
  filt.forEach(w=>{
    const div=document.createElement('div'); div.className='pill';
    div.textContent = `${w.dateISO} • ${w.sets.map(s=>`${fmt(s.weightKg)}×${s.reps}`).join(' · ')} • 1RM ${fmt(w.est1RM||0)}`;
    list.appendChild(div);
  });
  const last=filt[0];
  if(last){
    const topW=Math.max(...last.sets.map(s=>s.weightKg));
    const top=last.sets.find(s=>s.weightKg===topW) || last.sets[0];
    $('#lastMax').textContent = `${fmt(top.weightKg)}kg × ${top.reps}`;
    $('#lastDate').textContent = last.dateISO;
  } else {
    $('#lastMax').textContent='—'; $('#lastDate').textContent='—';
  }
}

/* ========== Suggestion row ========== */
async function computeSuggestion(){
  const exName = $('#exercise').value;
  const allW = await idbAll();
  const params = await getParamsFor(exName);

  const currentTop = currentSets.length ? currentSets.reduce((a,b)=> a.weightKg>b.weightKg?a:b).weightKg : null;
  const targetFromHist = await nextTargetWeight(allW, params, exName);
  const target = (targetFromHist ?? currentTop ?? 60);

  const sessionPlan = planFor(target, params);
  const done = currentSets.length;

  const sugW = $('#sugWeight'), sugR = $('#sugReps'), sugN = $('#sugNote');

  if(done >= sessionPlan.length){
    sugW.textContent='—'; sugR.textContent='—'; sugN.textContent='Klart för idag ✅';
    return;
  }
  const next = sessionPlan[done];
  sugW.textContent = `${fmt(next.weightKg)}kg`;
  sugR.textContent = `${next.reps}`;
  // Visa “Förslag” bara tills första setet lagts in
  sugN.textContent = (done === 0) ? 'Förslag' : '';
}

/* ========== Init & Events ========== */
async function refreshExerciseDropdown(sel){
  const all = await exAll(); all.sort((a,b)=> a.name.localeCompare(b.name,'sv'));
  sel.innerHTML='';
  for(const ex of all){ const o=document.createElement('option'); o.value=ex.name; o.textContent=ex.name; sel.appendChild(o); }
}
async function loadTodayFor(exName){
  const all=await idbAll();
  const dateISO=$('#date').value||todayISO();
  const exist=all.find(w=>w.dateISO===dateISO && w.exercise===exName);
  currentSets = exist ? exist.sets : [];
  renderCurrent(); renderHistory(all, exName); computeSuggestion();
}

(async function init(){
  await idbOpen(); await seedExercisesIfEmpty();
  $('#date').value = todayISO();
  await refreshExerciseDropdown($('#exercise'));
  if(!$('#exercise').value) $('#exercise').value='Marklyft';
  await loadTodayFor($('#exercise').value);
})();

$('#exercise').addEventListener('change', async ()=>{ await loadTodayFor($('#exercise').value); });

$('#add').addEventListener('click', async ()=>{
  const w = parseNumber($('#weight').value);
  const r = parseNumber($('#reps').value);
  if(w<=0 || r<=0) return alert('Ange både vikt och reps.');
  currentSets.push({weightKg:w, reps:r, done:true});
  $('#weight').value=''; $('#reps').value='';
  renderCurrent();
  await idbUpsertByDateExercise($('#date').value||todayISO(), $('#exercise').value, currentSets);
  computeSuggestion();
});

/* ========== Service worker ========== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker-v5.js'));
}
</script>
</body>
</html>
