<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Gym Logger — Pass (tap-to-log)</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="app.css" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#0A0E1A" />
  <style>
    :root{
      --bg:#0A0E1A; --panel:#111827; --panel-2:#0d1424;
      --line:#1F2937; --muted:#9CA3AF; --text:#E5E7EB;
      --ok:#22C55E; --warn:#EF4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing:.2px;
    }
    .wrap{max-width:820px;margin:0 auto;padding:8px 10px 80px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--line); border-radius:12px; padding:10px}
    .title{margin:0 0 6px;font-size:18px;font-weight:800}
    .row{display:flex;gap:6px;flex-wrap:wrap}
    .col{flex:1 1 220px}
    label{display:block;color:var(--muted);font-size:11px;margin:0 0 4px}

    /* Inputs – anti-zoom + kompakt */
    select,input,button{
      width:100%;padding:8px 10px;border-radius:9px;border:1px solid #243244;
      background:#000;color:var(--text);font-weight:700;font-size:16px
    }
    .btn{background:linear-gradient(180deg,#23c55e,#16a34a);border:none;cursor:pointer}
    .muted{color:var(--muted);font-size:11px}
    .sp{height:6px}

    /* Tabell kompakt */
    table{width:100%;border-collapse:collapse;background:#0b1220;border-radius:9px;overflow:hidden;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    th{background:#0f172a;font-weight:800;font-size:12px;letter-spacing:.3px}
    tr:last-child td{border-bottom:none}
    .ok{color:var(--ok);font-weight:800}
    .warn{color:var(--warn);font-weight:800}
    .ghostcell{opacity:.35}
    .delbtn{width:auto;min-width:auto;padding:4px 8px;border-radius:7px;border:1px solid #334155;background:transparent;color:#e5e7eb;font-size:13px;line-height:1}
    .clickable{cursor:pointer}
    .clickable:hover{background:#0e172e}
    .hint{color:#9CA3AF;font-size:11px;margin-top:4px}

    /* Animation */
    @keyframes pulse{0%{background-color:#16a34a22}100%{background-color:transparent}}
    tr.added{animation:pulse .5s ease-out}
  </style>
</head>
<body>
<div class="wrap">
  <section class="card" id="leftCard">
    <h1 class="title" id="exerciseTitle">Aktivt pass</h1>

    <!-- Övning + datum -->
    <div class="row">
      <div class="col">
        <label>Övning</label>
        <select id="exercise"></select>
      </div>
      <div class="col">
        <label>Datum</label>
        <input type="date" id="date">
      </div>
    </div>

    <div class="sp"></div>

    <!-- TABELL: klara överst, förslag under (tap-to-log) -->
    <table>
      <thead>
        <tr>
          <th>Vikt</th>
          <th>Reps</th>
          <th style="width:82px">Status</th>
          <th style="width:56px"></th>
        </tr>
      </thead>
      <tbody id="sessionBody"></tbody>
    </table>
    <div class="hint">Tips: tryck på en röd förslagsrad för att logga setet.</div>

    <div class="sp"></div>

    <!-- Inputs + Addera (för avvikelser/AMRAP) -->
    <div class="row">
      <div class="col">
        <label>Vikt (kg)</label>
        <input id="weight" inputmode="decimal" pattern="[0-9.,]*" autocomplete="off" autocapitalize="off" placeholder="t.ex. 140">
      </div>
      <div class="col">
        <label>Reps</label>
        <input id="reps" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocapitalize="off" placeholder="t.ex. 5">
      </div>
    </div>
    <div class="sp"></div>
    <button id="add" class="btn">Addera</button>

    <div class="sp"></div>
    <div class="row">
      <div class="col"><div class="muted" id="lastMaxBox">Senaste max: —</div></div>
      <div class="col"><div class="muted" id="lastDateBox">Senaste datum: —</div></div>
    </div>
  </section>
</div>

<!-- Bottenmeny -->
<nav class="tabbar">
  <a href="index.html" data-tab="pass">Pass</a>
  <a href="exercises.html" data-tab="exercises">Övningar</a>
  <a href="export.html" data-tab="export">Export</a>
  <a href="dashboard.html" data-tab="dashboard">Mer</a>
</nav>
<script src="nav.js"></script>

<script>
/* ===== IndexedDB ===== */
const DB_NAME='gymlogger_db';
let db;
function idbOpen(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB_NAME, 2);
    r.onupgradeneeded = e=>{
      const d=e.target.result;
      d.objectStoreNames.contains('workouts')||d.createObjectStore('workouts',{keyPath:'id',autoIncrement:true});
      d.objectStoreNames.contains('exercises')||d.createObjectStore('exercises',{keyPath:'name'});
    };
    r.onsuccess=()=>{db=r.result;res()}; r.onerror=()=>rej(r.error);
  });
}
function idbAll(){return new Promise((res,rej)=>{const tx=db.transaction('workouts','readonly');const st=tx.objectStore('workouts');const g=st.getAll();g.onsuccess=()=>res(g.result);g.onerror=()=>rej(g.error);});}
function idbAdd(workout){return new Promise((res,rej)=>{const tx=db.transaction('workouts','readwrite');tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);tx.objectStore('workouts').add(workout);});}
async function idbUpsertByDateExercise(dateISO, exercise, sets){
  const all=await idbAll();
  const found=all.find(w=>w.dateISO===dateISO && w.exercise===exercise);
  const est1RM = sets.length ? Math.max(...sets.map(s=>epley(totalForSet(s),s.reps))) : 0;
  if(found){
    await new Promise((res,rej)=>{const tx=db.transaction('workouts','readwrite');tx.objectStore('workouts').delete(found.id);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});
    await idbAdd({ id:found.id, dateISO, exercise, sets, est1RM, notes: found.notes||'' });
  } else {
    await idbAdd({ dateISO, exercise, sets, est1RM, notes:'' });
  }
}

/* ===== Exercises ===== */
function exAll(){return new Promise((res,rej)=>{const tx=db.transaction('exercises','readonly');const st=tx.objectStore('exercises');const g=st.getAll();g.onsuccess=()=>res(g.result);g.onerror=()=>rej(g.error);});}
function exPut(ex){return new Promise((res,rej)=>{const tx=db.transaction('exercises','readwrite');tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);tx.objectStore('exercises').put(ex);});}

/* ===== Util ===== */
const $=q=>document.querySelector(q);
const fmt=n=>Number(n).toLocaleString('sv-SE',{maximumFractionDigits:1});
const todayISO=()=>new Date().toISOString().slice(0,10);
// Epley använder total belastning
const epley=(w,r)=> r>1 ? w*(1+r/30) : w;
function parseNumber(value){
  if (value == null) return 0;
  let v = String(value).trim().replace(/\s+/g,'');
  if (v.includes('.') && v.includes(',')) v = v.replace(/,/g,''); else v = v.replace(',', '.');
  const n = Number(v); return Number.isFinite(n) ? n : 0;
}

/* ===== State & plan ===== */
let currentSets=[];         // {weightKg,reps}
let currentPlan=[];         // [{weightKg,reps,type,idx}]
const sessionTargetCache={}; // `${ex}|${date}` → vikt
let currentParams=null;
let userBodyweight = 80;    // TODO: gör inställning senare

/* ===== Seed defaults ===== */
async function seedExercisesIfEmpty(){
  const list = await exAll(); if(list.length) return;
  const defaults = [
    { name:'Marklyft', category:'base',   workSets:3, repsMin:3, repsMax:5,  warmups:[50,70,85], inc:2.5, bigInc:5, freqDays:5, baseWeightMode:'absolute' },
    { name:'Bänkpress',category:'hybrid', workSets:3, repsMin:6, repsMax:8,  warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:3, baseWeightMode:'absolute' },
    { name:'Knäböj',   category:'base',   workSets:3, repsMin:3, repsMax:5,  warmups:[50,70,85], inc:2.5, bigInc:5, freqDays:4, baseWeightMode:'absolute' },
    { name:'Militärpress',category:'hybrid',workSets:3,repsMin:6,repsMax:8,  warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:4, baseWeightMode:'absolute' },
    { name:'Chins',    category:'hybrid', workSets:3, repsMin:6, repsMax:10, warmups:[40,60],    inc:2.5, bigInc:5, freqDays:3, baseWeightMode:'bodyweight' },
    { name:'Bicepscurl',category:'iso',   workSets:3, repsMin:10,repsMax:15, warmups:[40],       inc:2.5, bigInc:5, freqDays:2, baseWeightMode:'absolute' }
  ];
  for(const ex of defaults) await exPut(ex);
}

/* ===== Bodyweight handling ===== */
function baseForParams(params){
  return params?.baseWeightMode==='bodyweight' ? userBodyweight : 0;
}
// total belastning för ett set
function totalForSet(s){
  return baseForParams(currentParams) + (parseFloat(s.weightKg)||0);
}

/* ===== Plan ===== */
async function getParamsFor(name){
  const all = await exAll(); const ex = all.find(x=>x.name===name);
  return ex || { name, category:'hybrid', workSets:3, repsMin:6, repsMax:8, warmups:[40,60,80], inc:2.5, bigInc:5, freqDays:3, baseWeightMode:'absolute' };
}
function lastWorkingSummary(all, exercise, workSets){
  const sessions=all.filter(w=>w.exercise===exercise).sort((a,b)=>b.dateISO.localeCompare(a.dateISO));
  if(!sessions.length) return null;
  const sets=[...sessions[0].sets].sort((a,b)=>b.weightKg-a.weightKg).slice(0, workSets||3);
  if(!sets.length) return null;
  return { dateISO:sessions[0].dateISO, workSets: sets };
}
async function nextTargetFromList(workouts, params, exName){
  const last=lastWorkingSummary(workouts, exName, params.workSets||3);
  if(!last) return null;
  const w = last.workSets[0].weightKg;
  const reps = last.workSets.map(s=>s.reps);
  const allHigh = reps.length>= (params.workSets||3) && reps.every(r=> r>= (params.repsMax||8));
  const anyLow  = reps.some(r=> r <= (params.repsMin||6)-1 );
  if(allHigh) return w + (params.bigInc||5);
  if(anyLow)  return Math.max(0, w - (params.inc||2.5));
  return w;
}
function buildPlan(targetWeight, params){
  const warm = (params.warmups||[]).map(pct=>{
    const w = Math.round(targetWeight*(pct/100)/2.5)*2.5;
    const reps = pct>=85 ? 1 : (pct>=70 ? 3 : 5);
    return { weightKg:w, reps, type:'warmup' };
  });
  const work = Array.from({length: params.workSets||3}, (_,i)=>({
    weightKg: targetWeight,
    reps: i===(params.workSets||3)-1 ? (params.category==='iso' ? `${params.repsMin}-${params.repsMax}` : 'AMRAP')
                                     : `${params.repsMin}-${params.repsMax}`,
    type:'work', idx:i+1
  }));
  return [...warm, ...work];
}

/* ===== Render ===== */
function renderTable(){
  const body = $('#sessionBody'); body.innerHTML='';
  const done = currentSets.length;

  // Klara set
  currentSets.forEach((s,i)=>{
    const tr=document.createElement('tr'); tr.classList.add('added');
    tr.innerHTML = `
      <td>${fmt(s.weightKg)}kg</td>
      <td>${s.reps}</td>
      <td><span class="ok">✓ Klar</span></td>
      <td><button class="delbtn" data-i="${i}" title="Ta bort">🗑︎</button></td>`;
    body.appendChild(tr);
  });

  // Förslagsrader (tap-to-log)
  for(let i=done;i<currentPlan.length;i++){
    const p=currentPlan[i];
    const lastWork = p.type==='work' && i===currentPlan.length-1;
    const note = lastWork ? 'Sista' : 'Förslag';
    const tr=document.createElement('tr');
    tr.classList.add('clickable');
    tr.dataset.planIndex = i; // för klick-handler
    tr.innerHTML = `
      <td class="warn">${fmt(p.weightKg)}kg</td>
      <td class="warn">${p.reps}</td>
      <td class="warn">${note}</td>
      <td class="ghostcell">—</td>`;
    body.appendChild(tr);
  }

  // Delete
  body.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick = async ()=>{
      const idx=+b.dataset.i;
      currentSets.splice(idx,1);
      renderTable();
      await idbUpsertByDateExercise($('#date').value||todayISO(), $('#exercise').value, currentSets);
      refreshRightSide();
    };
  });

  // Tap-to-log på förslagsrader
  body.querySelectorAll('tr.clickable').forEach(tr=>{
    tr.onclick = async ()=>{
      const idx = Number(tr.dataset.planIndex);
      const p = currentPlan[idx];
      let reps = p.reps;

      if (typeof reps === 'string') {
        // Hantera intervall/AMRAP via prompt
        let suggested = 0;
        const m = String(reps).match(/(\d+)\s*-\s*(\d+)/);
        if (m) suggested = Number(m[2]);
        const placeholder = m ? `${m[1]}-${m[2]}` : 'AMRAP';
        const input = prompt(`Ange reps för setet (${placeholder})`, suggested || '');
        const parsed = parseInt(input, 10);
        if (!parsed || parsed <= 0) return; // avbrutet/ogiltigt
        reps = parsed;
      }

      currentSets.push({weightKg:p.weightKg, reps:Number(reps)});
      renderTable();
      await idbUpsertByDateExercise($('#date').value||todayISO(), $('#exercise').value, currentSets);
      await refreshRightSide();
    };
  });
}

function renderHistoryMeta(all,ex){
  const filt=all.filter(w=>w.exercise===ex).sort((a,b)=>b.dateISO.localeCompare(a.dateISO)).slice(0,1);
  const last=filt[0];
  $('#lastMaxBox').textContent = last
    ? `Senaste max: ${fmt(Math.max(...last.sets.map(s=>s.weightKg)))}kg × ${last.sets.sort((a,b)=>b.weightKg-a.weightKg)[0].reps}`
    : 'Senaste max: —';
  $('#lastDateBox').textContent = `Senaste datum: ${last ? last.dateISO : '—'}`;
}

/* ===== Target/Plan ===== */
async function computeOrGetSessionTarget(exName, dateISO, params){
  const key = `${exName}|${dateISO}`;
  if (sessionTargetCache[key] != null) return sessionTargetCache[key];

  const allW = await idbAll();
  const past = allW.filter(w=>w.exercise===exName && w.dateISO < dateISO);
  let target = await nextTargetFromList(past, params, exName);
  if(target == null){ target = currentSets.length ? Math.max(...currentSets.map(s=>s.weightKg)) : 60; }
  sessionTargetCache[key] = target;
  return target;
}

async function refreshPlanOnly(){
  const exName = $('#exercise').value;
  const dateISO = $('#date').value || todayISO();
  currentParams = await getParamsFor(exName);
  const target = await computeOrGetSessionTarget(exName, dateISO, currentParams);
  currentPlan = buildPlan(target, currentParams);
  $('#exerciseTitle').textContent = exName;
  renderTable();
}

async function refreshRightSide(){
  const allW = await idbAll();
  renderHistoryMeta(allW, $('#exercise').value);
}

/* ===== Init & events ===== */
async function refreshExerciseDropdown(){
  const all = await exAll(); all.sort((a,b)=> a.name.localeCompare(b.name,'sv'));
  const sel=$('#exercise'); sel.innerHTML='';
  for(const ex of all){ const o=document.createElement('option'); o.value=ex.name; o.textContent=ex.name; sel.appendChild(o); }
}
async function loadTodayFor(exName){
  const all=await idbAll();
  const dateISO=$('#date').value||todayISO();
  const exist=all.find(w=>w.dateISO===dateISO && w.exercise===exName);
  currentSets = exist ? exist.sets : [];
  await refreshPlanOnly();
  await refreshRightSide();
}

(async function init(){
  await idbOpen(); await seedExercisesIfEmpty();
  $('#date').value = todayISO();
  await refreshExerciseDropdown();
  if(!$('#exercise').value) $('#exercise').value='Marklyft';
  await loadTodayFor($('#exercise').value);
})();

$('#exercise').addEventListener('change', async ()=>{ await loadTodayFor($('#exercise').value); });
$('#date').addEventListener('change', async ()=>{ await loadTodayFor($('#exercise').value); });

$('#add').addEventListener('click', async ()=>{
  // Manuell override – tomt = använd nästa förslag
  let w = parseNumber($('#weight').value);
  let r = parseNumber($('#reps').value);
  if((!w || !r) && currentPlan.length > currentSets.length){
    const next = currentPlan[currentSets.length];
    if(!w) w = next.weightKg;
    if(!r) {
      const m = String(next.reps).match(/(\d+)\s*-\s*(\d+)/);
      r = m ? Number(m[2]) : (String(next.reps).toLowerCase()==='amrap' ? 5 : Number(next.reps));
    }
  }
  if(w<=0 || r<=0) return alert('Ange både vikt och reps (eller tryck på förslagsraden).');

  currentSets.push({weightKg:w, reps:r});
  $('#weight').value=''; $('#reps').value='';
  renderTable();
  await idbUpsertByDateExercise($('#date').value||todayISO(), $('#exercise').value, currentSets);
  await refreshRightSide();
});

/* ===== Service worker ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker-v5.js'));
}
</script>
</body>
</html>
